<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kaisn.dao.EmployeeMapper">

	<resultMap type="com.kaisn.pojo.Employee" id="employee">
		<id column="EMP_ID" jdbcType="DECIMAL" property="empId" />
	    <result column="EMP_NAME" jdbcType="VARCHAR" property="empName" />
	    <result column="GENDER" jdbcType="CHAR" property="gender" />
	    <result column="EMAIL" jdbcType="VARCHAR" property="email" />
	    <result column="d_id" jdbcType="DECIMAL" property="deptId" />
	    <result column="old_dept_id" jdbcType="DECIMAL" property="oldDeptId" />
	    <association property="department" javaType="com.kaisn.pojo.Department">
	    	<id column="dept_id" jdbcType="DECIMAL" property="deptId" />
    		<result column="dept_name" jdbcType="VARCHAR" property="deptName" />
	    </association>
	</resultMap>
	
	<select id="getEmployeeList" resultType="com.kaisn.pojo.Employee">
		<!-- select 
		e.emp_id,
		e.emp_name,
		e.gender,
		e.email,
		d.dept_id,
		d.dept_name 
		from t_emp e 
		left join t_dept d 
		on e.d_id=d.dept_id
		order by e.update_time desc -->
		SELECT
			r.*,
		    t_a.dept_name,
		    t.dept_name
		FROM
		    (SELECT * FROM t_dept) AS t_a
		RIGHT JOIN t_emp r ON t_a.dept_id = r.d_id
		LEFT JOIN t_dept t ON t.dept_id = r.old_dept_id
		order by r.update_time desc
	</select>
	
	<select id="getEmployeeCountByName" parameterType="java.lang.String" resultType="int">
		select count(1) from t_emp where emp_name=#{empName,jdbcType=VARCHAR}
	</select>
	
	<insert id="addEmployee" parameterType="com.kaisn.pojo.Employee">
		insert into t_emp
		(
		emp_name,
		gender,
		email,
		d_id,
		old_dept_id,
		update_time
		) 
		values
		(
		#{empName,jdbcType=VARCHAR},
		#{gender,jdbcType=VARCHAR},
		#{email,jdbcType=VARCHAR},
		#{deptId,jdbcType=DECIMAL},
		#{oldDeptId,jdbcType=DECIMAL},
		now()
		)
	</insert>
	
	<delete id="delEmployee" parameterType="java.lang.String">
		delete from t_emp where emp_id in
		<foreach collection="array" item="empId" index="index" open="(" separator="," close=")">
			#{empId}
		</foreach>
	</delete>
	
	<select id="getEmployeeInfo" parameterType="java.lang.Long" resultType="com.kaisn.pojo.Employee">
		<!-- select 
		e.emp_id,
		e.emp_name,
		e.gender,
		e.email,
		e.d_id,
		d.dept_id,
		d.dept_name 
		from t_emp e 
		left join t_dept d 
		on e.d_id=d.dept_id
		where e.emp_id=#{empId,jdbcType=DECIMAL} -->
		SELECT
			r.*,
		    t_a.dept_name,
		    t.dept_name
		FROM
		    (SELECT * FROM t_dept) AS t_a
		RIGHT JOIN t_emp r ON t_a.dept_id = r.d_id
		LEFT JOIN t_dept t ON t.dept_id = r.old_dept_id
		where e.emp_id=#{empId,jdbcType=DECIMAL}
	</select>
	
	<update id="updateEmployee" parameterType="com.kaisn.pojo.Employee">
		update t_emp set 
		<if test="empName != null">
			emp_name=#{empName,jdbcType=VARCHAR},
		</if>
		<if test="gender != null">
			gender=#{gender,jdbcType=VARCHAR},
		</if>
		<if test="email != null">
			email=#{email,jdbcType=VARCHAR},
		</if>
		<if test="deptId != null">
			d_Id=#{deptId,jdbcType=DECIMAL},
		</if>
			update_time=now()
		where emp_id=#{empId,jdbcType=DECIMAL}
	</update>
	
	<insert id="addEmployeeList" parameterType="java.util.List">
		insert into t_emp
		(
		emp_name,
		gender,
		email,
		d_id,
		update_time
		) 
		values
		<foreach collection ="list" item="employee" index= "index" separator =",">
		(
		#{employee.empName,jdbcType=VARCHAR},
		#{employee.gender,jdbcType=VARCHAR},
		#{employee.email,jdbcType=VARCHAR},
		#{employee.deptId,jdbcType=DECIMAL},
		now()
		)
		</foreach >
	</insert>

</mapper>